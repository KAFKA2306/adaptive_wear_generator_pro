# ミニマル下着生成アドオン - アーキテクチャ

このドキュメントは、ミニマル下着生成Blenderアドオンの全体的な構造、各コンポーネントの役割、および状態管理とサービス間の接続について説明します。

## ファイル・フォルダ構造

```
.
├── __init__.py             # アドオンのエントリーポイント、登録/登録解除処理
├── README.md               # プロジェクト概要、インストール、基本的な使い方
├── tasks.md                # 開発タスクリスト
├── TROUBLESHOOTING.md      # トラブルシューティング情報
├── core/                   # コアロジックモジュール
│   ├── __init__.py
│   ├── blendshape_manager.py # ブレンドシェイプ管理
│   ├── bone_rigging.py     # ボーンリギング関連
│   ├── export_tools.py     # エクスポート機能
│   ├── fit_engine.py       # フィッティング調整ロジック
│   ├── material_manager.py # マテリアル管理（生成、適用など）
│   ├── mesh_generator.py   # メッシュ生成ロジック（パンツ生成など）
│   ├── operators.py        # Blenderオペレーター定義
│   ├── properties.py       # Blenderプロパティグループ定義
│   ├── uv_tools.py         # UV関連ツール
│   └── weight_transfer.py  # ウェイト転送機能
├── presets/                # 事前設定データ（JSON形式）
│   ├── blendshape_maps.json
│   ├── fit_profiles.json
│   ├── materials.json
│   └── wear_types.json
├── resources/              # リソースファイル（テクスチャ、アイコンなど）
├── services/               # ユーティリティおよびサービス層
│   ├── asset_manager.py    # アセット管理（ファイルI/Oなど）
│   ├── logging_service.py  # ログ出力サービス
│   └── vrc_utils.py        # VRChat関連ユーティリティ
├── tests/                  # テストコード
│   └── ... (テストファイル群)
└── ui/                     # ユーザーインターフェースモジュール
    ├── __init__.py
    ├── panel_blendshape.py # ブレンドシェイプ設定UIパネル
    ├── panel_export.py     # エクスポート設定UIパネル
    ├── panel_fit_adjust.py # フィッティング調整UIパネル
    ├── panel_main.py       # メインUIパネル（パンツ生成ボタンなど）
    ├── panel_material.py   # マテリアル設定UIパネル
    ├── panel_rigging.py    # リギング設定UIパネル
    ├── panel_settings.py   # 全体設定UIパネル
    ├── panel_style.py      # スタイル設定UIパネル
    └── ui_utils.py         # UI関連ユーティリティ関数
```

ルートディレクトリには、アドオンの登録を行う`__init__.py`や、プロジェクトに関するドキュメント（`README.md`, `tasks.md`, `TROUBLESHOOTING.md`）が含まれます。また、テスト実行用のスクリプトやその出力ファイルも配置されています。

## 各部分の役割

-   **`__init__.py`**:
    -   Blenderがアドオンとして認識するための必須ファイルです。
    -   アドオンの情報を定義します（`bl_info`）。
    -   アドオンで使用するクラス（プロパティ、パネル、オペレーターなど）をBlenderに登録 (`register()`) および登録解除 (`unregister()`) します。
-   **`core/`**:
    -   アドオンの中核となる処理ロジックを各機能ごとに分割して格納しています。
    -   `mesh_generator.py` はメッシュの生成アルゴリズムを、`material_manager.py` はマテリアルの作成や適用を、`fit_engine.py` はメッシュのフィッティング計算などを担当します。
    -   `operators.py` には、UIから実行される具体的な操作（例: パンツ生成）を定義するBlenderオペレータークラスが含まれます。
    -   `properties.py` には、Blenderのデータブロック（シーン、オブジェクトなど）に紐づけてアドオンの設定やユーザー入力を保持するためのカスタムプロパティグループが定義されます。
-   **`presets/`**:
    -   アドオンで使用される各種の事前設定データ（プリセット）をJSON形式で保持します。これにより、設定の管理や共有が容易になります。
-   **`resources/`**:
    -   アドオンが必要とする外部リソース（テクスチャ画像、アイコンファイルなど）を格納するためのディレクトリです。
-   **`services/`**:
    -   アドオンの特定の機能に直接関連しない、汎用的なユーティリティや外部連携などを担当するサービス層です。
    -   `asset_manager.py` はファイルシステムとのやり取りやアセットの読み込み/保存を抽象化します。
    -   `logging_service.py` はアドオンの実行中の情報、警告、エラーなどを記録する機能を提供します。
    -   `vrc_utils.py` はVRChatアバターに特有の処理やチェックなどを行う可能性があります。
-   **`tests/`**:
    -   アドオンの各機能が正しく動作することを確認するためのテストコード群です。開発中の品質保証に役立ちます。
-   **`ui/`**:
    -   Blenderのユーザーインターフェース要素（パネル、メニュー項目など）を定義します。
    -   `panel_*.py` ファイルは、特定の機能設定や操作ボタンを配置するためのカスタムUIパネルクラスを含みます。
    -   `ui_utils.py` は、UI要素の作成やレイアウトに関する共通のヘルパー関数を提供する可能性があります。

## 状態管理とサービス間の接続

-   **状態管理**:
    -   アドオンの状態（ユーザーが選択した素体、各種設定値など）は、主に `core/properties.py` で定義されたカスタムプロパティグループを通じて、Blenderのシーンデータ (`bpy.context.scene`) に格納されます。これにより、Blenderファイルと一緒に設定が保存・ロードされます。
    -   UIパネル (`ui/panel_*.py`) は、これらのシーンプロパティを参照・変更することでユーザー入力を受け付け、状態を表示します。
    -   オペレーター (`core/operators.py`) は、実行時に `context` オブジェクトを通じてシーンプロパティから必要な設定値を取得します。
    -   生成されたメッシュやマテリアルなどのBlenderデータは、Blenderの標準的なデータブロックシステムによって管理されます。
-   **サービス間の接続**:
    -   `__init__.py` がアドオンの起動時に全ての必要なクラスをBlenderに登録することで、各コンポーネントが利用可能になります。
    -   UIパネルは、レイアウト定義内でオペレーターの `bl_idname` を指定することで、ボタンクリックなどのユーザー操作からオペレーターを呼び出します。
    -   オペレーターは、アドオンのコアロジックを実行するために、`core/mesh_generator.py` や `core/material_manager.py` など、`core` ディレクトリ内のモジュールに含まれる関数やクラスのメソッドを呼び出します。
    -   `core` モジュールや `ui` モジュールは、ファイル操作が必要な場合（例: プリセットの読み込み/保存）に `services/asset_manager.py` を利用したり、デバッグ情報が必要な場合に `services/logging_service.py` を利用したりします。
    -   プリセットデータ (`presets/`) は、`services/asset_manager.py` などを通じて読み込まれ、`core` モジュール（特にフィッティングやマテリアル関連）で使用されます。

このアーキテクチャは、Blenderアドオン開発における一般的なパターン（UI、オペレーター、プロパティ、コアロジックの分離）に従っており、機能の拡張やメンテナンスが比較的容易になるように設計されています。